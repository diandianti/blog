---
title: Pythonä¸­çš„å¼‚æ­¥ä½¿ç”¨
date: 2021/12/30 21:00:00
update: 2021/12/30 21:00:00
tags:
- python
- å¼‚æ­¥
categories: python
excerpt: python? å¼‚æ­¥ï¼Ÿ
---

# Python ä¸­çš„å¼‚æ­¥

æœ¬æ–‡ä»‹ç»äº†pythonä¸­å¼‚æ­¥çš„æ¦‚å¿µä»¥åŠå¦‚ä½•ä½¿ç”¨å¼‚æ­¥æ¥å®Œæˆä»»åŠ¡ï¼Œéƒ¨åˆ†æ¦‚å¿µä¸ä»‹ç»å¹¶éå®˜æ–¹å‡†ç¡®çš„å®šä¹‰ï¼Œä¸ºä¸ªäººç†è§£ã€‚å¦‚éœ€æ›´åŠ åŸå§‹ä¸è¯¦ç»†çš„è¯´æ˜è¯·æŸ¥çœ‹å‚è€ƒæ–‡çŒ®ä¸­çš„é“¾æ¥ã€‚

æœ¬æ–‡åˆ†ä¸ºäº†ä»¥ä¸‹å‡ éƒ¨åˆ†ï¼šå¼‚æ­¥æ¦‚å¿µçš„ä»‹ç»ï¼Œå¼‚æ­¥çš„ä½¿ç”¨è§„åˆ™ï¼Œå¼‚æ­¥ä¸ç”Ÿæˆå™¨çš„è”ç³»ï¼Œä½¿ç”¨å¼‚æ­¥åº“ç¼–å†™ä¸€ä¸ªå®Œæ•´çš„ç¨‹åºï¼Œé›¶ç¢çš„å°çŸ¥è¯†ã€‚æ–‡ä¸­ä¸åŒ…å«å¼‚æ­¥å…·ä½“çš„å®ç°æ–¹å¼ã€‚

æ–‡ä¸­éƒ¨åˆ†ç¤ºä¾‹ä»£ç å¯ä»¥åœ¨è¿™ä¸ªåº“ä¸­æ‰¾åˆ° [https://github.com/realpython/materials/tree/master/asyncio-walkthrough](https://github.com/realpython/materials/tree/master/asyncio-walkthrough)

# è®¾ç½®ç¯å¢ƒ

- pythonç‰ˆæœ¬3.7ä»¥ä¸Š
- éœ€è¦pipåŒ…ï¼šaiohttp  aiofiles

# å¹¶å‘ å¹¶è¡Œ å¼‚æ­¥ï¼Ÿ

- å¹¶å‘ï¼šåŒä¸€æ—¶é—´å¤šæ¬¡è°ƒç”¨åŒä¸€æ¥å£ï¼Œç›¸åº”çš„æ¥å£ç¨‹åºå¯ä»¥åŒæ—¶å¤„ç†è¿™äº›è°ƒç”¨ï¼Œä¹Ÿå¯ä»¥ä¾æ¬¡å¤„ç†
- å¹¶è¡Œï¼šå¤šä¸ªæ“ä½œåŒæ—¶è¿è¡Œï¼Œå¯ä»¥ä½¿ç”¨å¤šçº¿ç¨‹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å¤šè¿›ç¨‹
- è¿›ç¨‹ï¼šå•ä¸ªç¨‹åºè¿è¡Œçš„è¿‡ç¨‹
- çº¿ç¨‹ï¼šä¸€ä¸ªè¿›ç¨‹å¯ä»¥æœ‰è‹¥å¹²ä¸ªçº¿ç¨‹ï¼Œè¿™äº›çº¿ç¨‹å…±äº«åŒä¸€è¿›ç¨‹çš„æŸäº›æ•°æ®

- å¹¶å‘å¹¶ä¸æ„å‘³ç€å¿…é¡»è¦ä½¿ç”¨å¹¶è¡ŒæŠ€æœ¯ï¼Œå› ä¸ºåœ¨æ¥å—åˆ°å¹¶å‘çš„çš„è°ƒç”¨ä¹‹åï¼Œæ‰€æœ‰çš„ä»»åŠ¡å¯ä»¥ä¾æ¬¡å¤„ç†ã€‚ä½†æ˜¯å¹¶è¡ŒæŠ€æœ¯å¯ä»¥æå‡å¹¶å‘çš„å¤„ç†èƒ½åŠ›ã€‚
- pythonç¨‹åºçš„å¤šçº¿ç¨‹å¹¶ä¸æ˜¯çœŸæ­£çš„å¤šçº¿ç¨‹ï¼Œå› ä¸º[GIL](https://docs.python.org/zh-cn/3/glossary.html#term-global-interpreter-lock)
- ä¸€å¼ è¯´æ˜å¹¶å‘ä¸å¹¶è¡Œçš„å›¾

![https://files.realpython.com/media/Screen_Shot_2018-10-17_at_3.18.44_PM.c02792872031.jpg](https://files.realpython.com/media/Screen_Shot_2018-10-17_at_3.18.44_PM.c02792872031.jpg)

å¼‚æ­¥å¯ä»¥ç†è§£ä¸ºä¸€ç§ä¸­æ–­æœºåˆ¶ï¼šåœ¨å°†è¦æ‰§è¡Œå¼‚æ­¥ä»£ç æ—¶å€™ï¼Œç¨‹åºä¼šæŠŠæ§åˆ¶æƒç§»äº¤ç»™è°ƒç”¨è¯¥å‡½æ•°çš„ä¸Šä¸€çº§ç„¶åå‘Šè¯‰ä¸Šä¸€çº§ç­‰æˆ‘æ‰§è¡Œå®Œè¿™éƒ¨åˆ†ç¨‹åºç»™ä½ å‘ä¿¡å·ä¹‹åå°±æŠŠæ§åˆ¶æƒè¿˜å›æ¥ï¼Œä¹‹åä¾¿æ‰§è¡Œå¼‚æ­¥ä»£ç ï¼Œåœ¨å¼‚æ­¥ä»£ç ç»“æŸåå‘ä¿¡å·ç´¢è¦æ§åˆ¶æƒã€‚

ä¸¾ä¸ªä¾‹å­ï¼šæœ‰ä¸¤ä¸ªäººAå’ŒBåŒæ—¶åœ¨å‡†å¤‡æ™šé¥­ï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªäººåªæœ‰ä¸€æŠŠèœåˆ€ï¼Œè¿™ä¸ªæ—¶å€™Aå’ŒBå«æ¥äº†Cå¸®å¿™åœ¨ä¸­é—´ä¼ é€’èœåˆ€ã€‚Açš„åšèœé¡ºåºæ˜¯ åˆ‡èœâ†’ ç„¯æ°´â†’ å†åˆ‡ä¸€é â†’ ç‚’èœï¼ŒBçš„åšèœé¡ºåºæ˜¯ æ´—èœ â†’ åˆ‡èœ â†’ ç‚’èœï¼Œå¦‚å›¾æ‰€ç¤ºï¼š

![https://s6.jpg.cm/2021/12/28/LHVec2.png](https://s6.jpg.cm/2021/12/28/LHVec2.png)

ä¾‹å­ä¸­çš„èœåˆ€å°±æ˜¯å¼‚æ­¥ä¸­çš„ç¨‹åºæ§åˆ¶æƒï¼Œå›¾ä¸­çš„æ©™è‰²çº¿å’Œç½‘æ ¼å—å°±æ˜¯æ§åˆ¶æƒçš„ç§»äº¤æ­¥éª¤ï¼Œé¦–å…ˆAæ‹¿åˆ°èœåˆ€ï¼Œä¹Ÿå°±æ˜¯æ§åˆ¶æƒï¼Œå¼€å§‹å¤„ç†ç¨‹åºã€‚ç­‰Aå¤„ç†å®Œäº†åˆ‡èœçš„æ­¥éª¤ä¹‹åæŠŠèœåˆ€ç»™Cï¼Œå¹¶ä¸”è¦åœ¨ä¸‹ä¸€æ¬¡åˆ‡èœçš„æ—¶å€™å†è¦å›æ¥ï¼Œç„¶åAå¼€å§‹å¤„ç†ç„¯æ°´ç¨‹åºã€‚è¿™ä¸ªæ—¶å€™Bå¤„ç†å®Œäº†æ´—èœç¨‹åºï¼Œå‘Cç´¢è¦æ§åˆ¶æƒè¿›è¡Œåˆ‡èœï¼Œåœ¨å¤„ç†å®Œåˆ‡èœç¨‹åºä¹‹åè¿›è¡Œå’ŒAä¸€æ ·çš„æ“ä½œã€‚åœ¨Aå¤„ç†å®Œç„¯æ°´æ­¥éª¤ä¹‹åå°±ç´¢è¦æ§åˆ¶æƒï¼Œå¦‚æœæ§åˆ¶æƒæ­£å¥½ç©ºé—²é‚£ä¹ˆAå¯ä»¥æ‹¿åˆ°ï¼Œå¦‚æœæ­¤æ—¶Bæ²¡æœ‰å½’è¿˜é‚£ä¹ˆAéœ€è¦è¿›è¡Œç­‰å¾…ã€‚Cåœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­å°±åœ¨ä¸åœçš„é—®Aå’ŒBèœåˆ€è¿˜åœ¨ç”¨å—ï¼Ÿéœ€è¦èœåˆ€å—ï¼Ÿåœ¨Aå’ŒBéœ€è¦èœåˆ€å’Œä¸éœ€è¦çš„æ—¶å€™å°†èœåˆ€æ‹¿åˆ°è‡ªå·±çš„æ‰‹ä¸Šä»¥ä¾¿äºä¸‹ä¸€æ¬¡çš„ä¼ é€’ã€‚

ä¾‹å­ä¸­Aå’ŒBå°±æ˜¯ä¸¤ä¸ªéœ€è¦æ§åˆ¶æƒçš„åç¨‹ï¼Œè€ŒCå°±æ˜¯ç³»ç»Ÿï¼Œæ¥æ§åˆ¶ä¸åŒçš„åç¨‹å®Œæˆå·¥ä½œã€‚

# ä¸ºä»€ä¹ˆè¦æœ‰å¼‚æ­¥ï¼Ÿ

å¼‚æ­¥çš„é—®é¢˜å®Œå…¨å¯ä»¥ç”±å¤šçº¿ç¨‹æˆ–è€…å¤šè¿›ç¨‹æ¥å®Œæˆï¼Œé‚£ä¸ºä»€ä¹ˆè¿˜è¦å¼•å…¥å¼‚æ­¥æ“ä½œå‘¢ï¼Ÿ

- å¼‚æ­¥æ“ä½œæ¯”å¤šçº¿ç¨‹ä¸å¤šè¿›ç¨‹æ›´åŠ çš„è½»é‡åŒ–å³ç›¸åŒæ•°ç›®çš„æ“ä½œéœ€è¦çš„èµ„æºæ›´å°‘
- å› ä¸ºè½»é‡åŒ–æ‰€ä»¥å¼‚æ­¥çš„å¹¶å‘æ•°å¯ä»¥æ¯”å¤šçº¿ç¨‹ä¸å¤šçº¿ç¨‹æ›´å¤š

# asyncioåŒ…ä¸async/await

## åç¨‹ç¤ºä¾‹

**å¼‚æ­¥çš„æ ¸å¿ƒæ˜¯åç¨‹**ï¼Œåç¨‹æ˜¯pythonçš„ç”Ÿæˆå™¨å‡½æ•°çš„ä¸€ç§ç‰¹ä¾‹ã€‚ä½¿ç”¨å¼‚æ­¥è¯­æ³•è¿è¡Œçš„å‡½æ•°å°±ä¼šåˆ›å»ºä¸€ä¸ªåç¨‹ï¼Œåç¨‹å¯ä»¥åœ¨è¿è¡Œåˆ°returnè¯­å¥ä¹‹å‰æŒ‚èµ·ï¼ˆæ„å‘³ç€æŠŠæ§åˆ¶æƒè½¬è®©ç»™è°ƒç”¨ç¨‹åºï¼Œä½†æ˜¯åç¨‹è¿˜åœ¨è¿è¡Œï¼‰ï¼Œå¹¶ä¸”åç¨‹å¯ä»¥æŠŠç³»ç»Ÿçš„æ§åˆ¶æƒè½¬è®©ç»™å…¶ä»–çš„åç¨‹ã€‚

é¦–å…ˆæ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š

```python
#!/usr/bin/env python3
# countsaync.py

# ä½¿ç”¨asyncioé‡Œé¢çš„sleepç­‰å‡½æ•°
import asyncio

# async ä¸ awaitæ˜¯pythonçš„å…³é”®å­—ï¼Œä¸æ˜¯asyncioåŒ…é‡Œé¢çš„
async def count():
	print("One")
	# è¿è¡Œåˆ°ä¸‹é¢è¿™ä¸€å¥çš„æ—¶å€™ä¸‹é¢çš„ç¨‹åºä¼šç»§ç»­æ‰§è¡Œï¼Œç›´åˆ°ç¨‹åºsleepè¿”å›
	# ä½†æ˜¯æ­¤æ—¶ç¨‹åºä¼šå°†æ§åˆ¶æƒè¿”å›ï¼Œè¿™æ—¶å€™ä¼šæœ‰å¦ä¸€ä¸ªåç¨‹è·å¾—æ§åˆ¶æƒ
	# å¦ä¸€ä¸ªç¨‹åºä¼šé‡å¤ç±»ä¼¼çš„æ“ä½œ
	await asyncio.sleep(1)
	print("Two")

async def main():
	await asyncio.gather(count(), count(), count)

if __name__ == "__main__":
	import time
	s = time.perf_counter()
	asyncio.run(main())
	elapsed = time.perf_counter() - s
	print(f"{__file__} executed in {elapsed:0.2f} seconds")
```

è¿è¡Œç¨‹åºï¼ŒæŸ¥çœ‹è¾“å‡ºï¼š

```bash
$ python3 countasync.py
One
One
One
Two#ç»è¿‡1ç§’ä¹‹å
Two
Two
countasync.py executed in 1.01 seconds.
```

ä¸€ä¸ªç±»ä¼¼çš„ç¨‹åºï¼Œä½†æ˜¯æ˜¯éå¼‚æ­¥ç‰ˆæœ¬

```python
#!/usr/bin/env python3
# countsync.py

import time

def count():
	print("One")
	time.sleep(1)
	print("Two")

def main():
	for _ in range(3):
		count()

if __name__ == "__main__":
	s = time.perf_counter()
	main()
	elapsed = time.perf_count() - s
	print(f"{__file__} executed in {elapsed:0.2f} seconds."}

```

è¿è¡Œç¨‹åºï¼ŒæŸ¥çœ‹è¾“å‡º

```python
$ python3 countsync.py
One
Two
One
Two
One
Two
countsync.py executed in 3.01 seconds.
```

å¯ä»¥çœ‹å‡ºä»¥åŒæ­¥æ–¹å¼æ¥è¿è¡Œçš„ç¨‹åºæ—¶é—´ä¸º3sï¼Œè€Œå¼‚æ­¥æ–¹å¼ä¸º1sã€‚åŒæ­¥æ–¹å¼è¿è¡Œçš„ç¨‹åºä¸­ï¼Œåœ¨sleepçš„æ—¶å€™ç¨‹åºè¢«é˜»å¡ä½ï¼Œä¸èƒ½å¤Ÿç»§ç»­è¿è¡Œæˆ–è€…è½¬ç§»æ§åˆ¶æƒåªèƒ½æ•´ä¸ªç¨‹åºç­‰å¾…sleepï¼Œè€Œå¼‚æ­¥æ–¹å¼å¯ä»¥è®©å…¶ä»–çš„åç¨‹åœ¨ç­‰å¾…çš„æ—¶å€™è¿è¡Œï¼ŒèŠ‚çœäº†æ—¶é—´ã€‚

## å¼‚æ­¥IOçš„è§„åˆ™

- async def å¯ä»¥ç”¨æ¥å®šä¹‰ä¸€ä¸ªåç¨‹æˆ–è€…ä¸€ä¸ªå¼‚æ­¥ç”Ÿæˆå™¨ï¼Œasyncå¯ä»¥å’Œasync foråŒæ—¶ä½¿ç”¨ï¼Œä¸‹é¢å°±æœ‰è¿™æ ·çš„ä¾‹å­ã€‚
- å…³é”®å­—awaitä¼šå°†æ§åˆ¶æƒè¿˜ç»™event loop
    
    ```python
    async def g():
    	#è¿”å›æ§åˆ¶æƒï¼Œå½“f()è¿è¡Œç»“æŸè¿”å›çš„æ—¶å€™è¦å›æ§åˆ¶æƒ
    	r = await f()
    	return r
    ```
    
- å¦‚æœasync defæ¥å®šä¹‰ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œawait return å’Œyieldéƒ½æ˜¯å¯ä»¥å†å‡½æ•°ä¸­ä½¿ç”¨çš„ï¼Œasync def noop(): pass ä¹Ÿæ˜¯å¯ä»¥çš„
    - å¿…é¡»ä½¿ç”¨awaitæ¥è·å–ä¸€ä¸ªå¼‚æ­¥å‡½æ•°çš„ç»“æœ
    - åœ¨async defå®šä¹‰çš„å‡½æ•°ä¸­å¯ä»¥ä½¿ç”¨yieldå…³é”®å­—ï¼ˆåªæœ‰æ–°ç‰ˆæœ¬çš„pythonä¸­å¯ä»¥ï¼‰
    - async defå®šä¹‰çš„å‡½æ•°ä¸­ä¸å¯ä»¥ä½¿ç”¨yield from
- awaitä¸å¯ä»¥åœ¨éå¼‚æ­¥å‡½æ•°ä¸­ä½¿ç”¨
    
    ```python
    async def f(x):
    	y = await z(x) #await å’Œreturnå…³é”®å­—å¯ä»¥åœ¨å¼‚æ­¥å‡½æ•°ä¸­ä½¿ç”¨
    	return y
    
    async def g(x):
    	yield x #è¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥ç”Ÿæˆå™¨
    
    async def m(x):
    	yield from gen(x) #è¯­æ³•é”™è¯¯
    
    def m(x):
    	y = await z(x) #è¯­æ³•é”™è¯¯ï¼Œawaitä¸å¯ä»¥åœ¨éå¼‚æ­¥å‡½æ•°ä¸­ä½¿ç”¨
    	return y
    ```
    

- å½“ä½ ä½¿ç”¨await f()çš„æ—¶å€™ï¼Œf()å¿…é¡»æ˜¯å¯ç­‰å¾…çš„ï¼ˆawaitableï¼‰ï¼Œæœ‰ä¸¤ç§æƒ…å†µ
    - f()æ˜¯ä¸€ä¸ªåç¨‹
    - f()æ˜¯ä¸€ä¸ªå®šä¹‰äº†__await__()æ–¹æ³•çš„å¯¹è±¡ï¼Œå¹¶ä¸”è¿™ä¸ªå‡½æ•°è¿”å›äº†ä¸€ä¸ªè¿­ä»£å¯¹è±¡
- å¯ä»¥ä½¿ç”¨è£…é¥°å™¨çš„æ–¹å¼æ¥åˆ›å»ºåŸºäºç”Ÿæˆå™¨çš„åç¨‹ï¼Œä¸è¦è¿‡å¤šçš„çº ç»“äºè¿™æ ·çš„ä½¿ç”¨æ–¹å¼ï¼Œåœ¨python 3.10ç‰ˆæœ¬ä¹‹åè¿™æ ·çš„ä½¿ç”¨æ–¹å¼å°±ä¼šè¢«åˆ é™¤ã€‚
    
    ```python
    import asyncio
    
    # è¾ƒæ—©çš„è¯­æ³•
    @asyncio.coroutine
    def py34_coro():
    	yield from stuff()
    
    # æ›´åŠ ç°ä»£çš„è¯­æ³•
    async def py35_coro():
    	await stuff()
    ```
    

åœ¨äº†è§£äº†å¼‚æ­¥IOçš„è§„åˆ™ä¹‹åï¼Œå†çœ‹ä¸€ä¸ªä¾‹å­ï¼Œè¿™ä¸ªç¤ºä¾‹ç¨‹åºå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨å¼‚æ­¥æ–¹å¼æ¥èŠ‚çœç¨‹åºçš„è¿è¡Œæ—¶é—´ã€‚

```python
#!/usr/bin/env python3
# rand.py

import asyncio
import random

c = (
	"\033[0m", #æ¸…é™¤ç»ˆç«¯æ‰“å°çš„æ ¼å¼
	"\033[36m", # é’è‰²ï¼ŒCyan
	"\033[91m", #çº¢è‰²ï¼ŒRed
	"\033[35m", # å“çº¢ï¼ŒMegenta
)

async def makerandom(idx:int, threshold:int = 6)->int:
	print(c[idx + 1] + f"Inititaed makerandom ({idx}).")
	i = random.randint(0, 10)
	while i <= threshold:
		print(c[idx  + 1] + f"makerandom ({idx}) == {i} too low; retrying.")
		await asyncio.sleep(idx + 1)
		i = random.randint(0, 10)

	print(c[idx + 1] + f"---->Finished: makerandom ({idx}) == {i}"  + c[0])

async def main():
	res = await asyncio.gather(*(makerandom(i, 10 - i -1) for i in range(3)))
	return res

if __name__ == "__main__":
	random.seed(666)
	r1, r2, r3 = asyncio.run(main())
	print()
	print(f"r1: {r1} r2:{r2} r3:{r3}")
```

è¾“å‡ºæ•ˆæœï¼š

![https://files.realpython.com/media/asyncio-rand.dffdd83b4256.gif](https://files.realpython.com/media/asyncio-rand.dffdd83b4256.gif)

ä¸Šé¢çš„ä»£ç ä¸­å®šä¹‰äº†ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œå¹¶ä¸”ç”¨è¿™ä¸ªå‡½æ•°åˆ›å»ºäº†ä¸‰ä¸ªä¸åŒè¾“å…¥çš„åç¨‹ï¼Œåœ¨å®é™…çš„åº”ç”¨ä¸­è¾“å…¥å¯èƒ½æ˜¯ä¸€ä¸ªurlçš„åˆ—è¡¨ï¼Œè¿™æ ·å¼‚æ­¥æ“ä½œå°±å¯ä»¥å¤„ç†å¤šä¸ªwebè¯·æ±‚ã€‚ç¨‹åºä¸­è·å–éšæœºæ•°çš„éƒ¨åˆ†å¯ä»¥çœ‹ä½œä¸ºè®¡ç®—å¯†é›†çš„æ“ä½œï¼Œè€Œsleepéƒ¨åˆ†å¯ä»¥çœ‹ä½œä¸ºIOå¯†é›†çš„æ“ä½œï¼Œé‡‡ç”¨å¼‚æ­¥å¯ä»¥åœ¨IOå¯†é›†çš„æ“ä½œéƒ¨åˆ†èŠ‚çœå¤§é‡çš„æ—¶é—´ã€‚

# å¼‚æ­¥IOçš„è®¾è®¡æ¨¡å¼

## é“¾å¼åç¨‹

å¼‚æ­¥å‡½æ•°å¯ä»¥é“¾å¼è°ƒç”¨å³å¯ä»¥åœ¨ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ä¸­å¤šæ¬¡è°ƒç”¨ä¸åŒçš„å¼‚æ­¥å‡½æ•°ï¼Œè¿™æ ·å¯ä»¥å°†æ•´ä¸ªç¨‹åºåˆ†å‰²ä¸ºè‹¥å¹²éƒ¨åˆ†ï¼Œæ–¹ä¾¿è°ƒç”¨ã€‚

ä¾‹å­

```python
#!/usr/bin/env python3
# chained.py

import sayncio
import random
import time

async def part1(n: int) -> str:
	i = random.randint(0, 10)
	print(f"part1 ({n}) sleep for {i} seconds.")
	await asyncio.sleep(i)
	result = f"result{n} - 1"
	print(f"Returning part1 ({1}) == {result}")
	return result

async def part2(n:int, arg:str)->str:
	i = random.randint(0,10)
	print(f"part2 {n,arg} sleeping for {i} seconds.")
	await asyncio.sleep(i)
	result = f"result {n} -2 derived from {arg}"
	print(f"Returning part2 {n, arg} == {result}")
	return result

async def chain(n:int)->None:
	start = time.perf_counter()
	p1 = await part1(n)
	p2 = await part2(n, p1)
	end = time.perf_counter() - start
	print(f"-->Chained result {n} => {p2} (took {end:0.5f} seconds).")

async def main(*args):
	await asyncio.gather(*(chain(n) for n in args))

if __name__ == "__main__":
	import sys
	random.seed(666)
	args = [1, 2, 3] if len(sys.argv) == 1 else map(int, sys.argv[1:])
	start = time.perf_counter()
	asyncio.run(main(*args))
	end = time.perf_counter() - start
	print(f"Program finished in {end: 0.5f} seconds.")
	
```

è¿è¡Œç¨‹åºï¼ŒæŸ¥çœ‹è¾“å‡º

```python
$ python3 chained.py 9 6 3
part1(9) sleeping for 4 seconds.
part1(6) sleeping for 4 seconds.
part1(3) sleeping for 0 seconds.
Returning part1(3) == result3-1.
part2(3, 'result3-1') sleeping for 4 seconds.
Returning part1(9) == result9-1.
part2(9, 'result9-1') sleeping for 7 seconds.
Returning part1(6) == result6-1.
part2(6, 'result6-1') sleeping for 4 seconds.
Returning part2(3, 'result3-1') == result3-2 derived from result3-1.
-->Chained result3 => result3-2 derived from result3-1 (took 4.00 seconds).
Returning part2(6, 'result6-1') == result6-2 derived from result6-1.
-->Chained result6 => result6-2 derived from result6-1 (took 8.01 seconds).
Returning part2(9, 'result9-1') == result9-2 derived from result9-1.
-->Chained result9 => result9-2 derived from result9-1 (took 11.01 seconds).
Program finished in 11.01 seconds.
```

## ä½¿ç”¨é˜Ÿåˆ—

åœ¨asyncioåº“ä¸­æä¾›äº†é˜Ÿåˆ—ç±»ï¼Œä½œç”¨å’Œæ™®é€šçš„é˜Ÿåˆ—ç±»ä¼¼ï¼Œä¸è¿‡å®ƒæ˜¯å¼‚æ­¥çš„ã€‚æ­¤å¤–å¼‚æ­¥ä¸­çš„é˜Ÿåˆ—æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå³å¯ä»¥åŒæ—¶è®¿é—®é˜Ÿåˆ—æ•°æ®è€Œæ— éœ€è€ƒè™‘æ•°æ®å®‰å…¨ã€‚

ä¸¾ä¾‹ä¸€ä¸ªåœºæ™¯ï¼šæœ‰è‹¥å¹²çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼Œå¹¶ä¸”ä»»æ„çš„æ¶ˆè´¹è€…æˆ–è€…ç”Ÿäº§è€…æ²¡æœ‰ç›¸äº’å…³ç³»ï¼Œä¸éœ€è¦ç›¸äº’åä½œï¼Œç”Ÿäº§è€…åªéœ€è¦å°†äº§å“æ”¾å…¥é˜Ÿåˆ—ï¼Œè€Œæ¶ˆè´¹å€¼éœ€è¦ä¸åœçš„æ‹¿å–äº§å“å¤„ç†ã€‚

å¯¹äºåŒæ­¥å¤„ç†çš„ç¨‹åºï¼Œéœ€è¦è®©æ‰€æœ‰çš„æ¶ˆè´¹è€…ç­‰å¾…ç”Ÿäº§è€…çš„ç”Ÿäº§ï¼Œåœ¨æ‰€æœ‰çš„ç”Ÿäº§è€…å®Œæˆä»»åŠ¡ä¹‹åï¼Œæ¶ˆè´¹è€…ä»¬ä¾æ¬¡å–ä¸‹äº§å“å¤„ç†ï¼Œæ•´ä¸ªè¿‡ç¨‹ååˆ†è€—æ—¶ã€‚å½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡å¤šçº¿ç¨‹çš„æ–¹å¼ï¼Œæœ‰è‹¥å¹²çº¿ç¨‹æ¥å®Œæˆç”Ÿäº§å’Œæ¶ˆè´¹çš„åŠ¨ä½œã€‚

ä½¿ç”¨å¼‚æ­¥ç¨‹åºå¤„ç†ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

```python
#!/usr/bin/env python3
# asyncq.py

import asyncio
import random
import itertools as it
import os
import time

async def makeitem(size: int = 5)->str:
	return os.urandom(size).hex()

async def randsleep(caller:str = None)->None:
	i = random.randint(0, 10)
	if caller:
		print(f"{caller} sleep for {i} seconds.")
	await asyncio.sleep(i)

async def produce(name:int, q:asyncio.Queue)->None:
	n = random.randint(0, 10)
	for _ in it.repeat(None, n):
		await randsleep(caller=f"Producer {name}")
		i = await makeitem()
		t = time.perf_counter()
		await q.put((i, t))
		print(f"Producer {name} add <{i}> to queue.")

async def consume(name:int, q:asyncio.Queue)->None:
	while True:
		await randsleep(caller=f"Consumer {name}")
		i,t = await q.get()
		now = time.perf_counter()
		print(f"Consumer {name} got element <{i}> in {now - t:0.5f} seconds)
		q.task_done()

async def main(np:int, nc:int):
	q = asyncio.Queue()
	producers = [asyncio.create_task(produce(n, q) for n in range(np))]
	consumers = [asyncio.create_task(consume(n, q) for n in range(nc))]
	await asyncio.gather(*produers)
	await q.join()
	for c in consumers:
		c.cancel()

def cli(np:int=5, nc:int=10):
	random.seed(666)
	start = time.perf_counter()
	asyncio.run(main(np, nc))
	elapsed = time.perf_counter()
	print(f"Program completed in {elapsed:0.5f} seconds.")

if __name__ == "__main__":
	import fire
	fire.Fire(cli)

```

è¿è¡Œç¨‹åºï¼ŒæŸ¥çœ‹ç»“æœ

```python
$ python3 asyncq.py --np 2 --nc 5
Producer 0 sleeping for 3 seconds.
Producer 1 sleeping for 3 seconds.
Consumer 0 sleeping for 4 seconds.
Consumer 1 sleeping for 3 seconds.
Consumer 2 sleeping for 3 seconds.
Consumer 3 sleeping for 5 seconds.
Consumer 4 sleeping for 4 seconds.
Producer 0 added <377b1e8f82> to queue.
Producer 0 sleeping for 5 seconds.
Producer 1 added <413b8802f8> to queue.
Consumer 1 got element <377b1e8f82> in 0.00013 seconds.
Consumer 1 sleeping for 3 seconds.
Consumer 2 got element <413b8802f8> in 0.00009 seconds.
Consumer 2 sleeping for 4 seconds.
Producer 0 added <06c055b3ab> to queue.
Producer 0 sleeping for 1 seconds.
Consumer 0 got element <06c055b3ab> in 0.00021 seconds.
Consumer 0 sleeping for 4 seconds.
Producer 0 added <17a8613276> to queue.
Consumer 4 got element <17a8613276> in 0.00022 seconds.
Consumer 4 sleeping for 5 seconds.
Program completed in 9.00954 seconds.
```

å¯ä»¥å°è¯•æ›´æ”¹æ¶ˆè´¹è€…å’Œç”Ÿäº§è€…çš„æ•°ç›®ç„¶åæŸ¥çœ‹ç¨‹åºæœ€ç»ˆçš„è¿è¡Œæ—¶é—´ï¼Œéšç€ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ•°ç›®çš„å¢åŠ ï¼Œç¨‹åºçš„æ‰§è¡Œæ—¶é—´å´æ²¡æœ‰å¤ªå¤§çš„å˜åŒ–ã€‚å½±å“è¿™ä¸ªç¨‹åºè¿è¡Œæ—¶é—´çš„åŸå› æœ‰ä¸¤ä¸ªï¼š

- æ— å¯é¿å…çš„ç¨‹åº¦æ‰§è¡Œè€—æ—¶å³æ¯æ¡è¯­å¥ä»¥åŠåç¨‹åˆ‡æ¢çš„æ—¶é—´
- å½“æ‰€æœ‰çš„æ¶ˆè´¹è€…éƒ½åœ¨sleepçš„æ—¶å€™é˜Ÿåˆ—ä¸­æ”¾å…¥äº†æ•°æ®ï¼Œå¯¼è‡´æ•°æ®æ— æ³•å¤„ç†

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨è¿™ä¸ªç¨‹åºä¸­å¯ä»¥ä¸€ç›´å¢åŠ æ¶ˆè´¹è€…å’Œç”Ÿäº§è€…çš„æ•°é‡ï¼Œä½†æ˜¯å½“ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…è¾¾åˆ°ä¸€å®šæ•°ç›®åï¼ŒPCçš„CPUæ€§èƒ½å°±å˜æˆäº†é™åˆ¶ç¨‹åºé€Ÿåº¦çš„ä¸»è¦å› ç´ ï¼Œç¨‹åºçš„æ‰§è¡Œé€Ÿåº¦å˜æ…¢ã€‚

# æ·±å…¥äº†è§£å¼‚æ­¥IOä¸ç”Ÿæˆå™¨

## ä¾‹å­

é¦–å…ˆçœ‹ä¸€ä¸ªä¾‹å­

```python
import asyncio

@asyncio.coroutine
def py34_coro():
    """Generator-based coroutine"""
    # No need to build these yourself, but be aware of what they are
    s = yield from stuff()
    return s

async def py35_coro():
    """Native coroutine, modern syntax"""
    s = await stuff()
    return s

async def stuff():
    return 0x10, 0x20, 0x30
```

åˆ†åˆ«ç›´æ¥è¿è¡Œ py34_coro()å’Œpy35_coro()ï¼ŒæŸ¥çœ‹è¾“å‡º

```python
In [5]: py35_coro()
Out[5]: <coroutine object py35_coro at 0x7fa84498c830>

In [6]: py34_coro()
Out[6]: <generator object py34_coro at 0x7fa844933050>
```

ç›´æ¥è¿è¡Œå‡½æ•°å¹¶æ²¡æœ‰å¾—åˆ°æœŸæœ›çš„ç»“æœï¼Œè€Œæ˜¯å¾—åˆ°äº†ä¸€ä¸ªå¯¹è±¡ï¼Œå¯ä»¥åˆ†åˆ«ç§°ä¸ºç”Ÿæˆå™¨å¯¹è±¡å’Œåç¨‹å¯¹è±¡ã€‚

å†æ¥ä¸€ä¸ªç”Ÿæˆå™¨çš„ä¾‹å­

```python
>>> def gen():
...     yield 0x10, 0x20, 0x30
...
>>> g = gen()
>>> g  # Nothing much happens - need to iterate with `.__next__()`
<generator object gen at 0x1012705e8>
>>> next(g)
(16, 32, 48)
```

å½“è°ƒç”¨ç”Ÿæˆå™¨å‡½æ•°çš„æ—¶å€™ä¼šè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œå¦‚æœæƒ³è¦å¾—åˆ°å‡½æ•°çš„è¿”å›å€¼åˆ™éœ€è¦ä½¿ç”¨nextå‡½æ•°æ¥è·å–ã€‚å¼‚æ­¥å‡½æ•°ä¹Ÿæ˜¯ç±»ä¼¼çš„å®ç°æ€è·¯ï¼Œç›´æ¥è°ƒç”¨å‡½æ•°ä¼šå¾—åˆ°ä¸€ä¸ªå¯¹è±¡ï¼Œå¦‚æœæƒ³è¦å¾—åˆ°å‡½æ•°çš„è¿”å›å€¼å°±éœ€è¦ä½¿ç”¨asyncio.run()ç­‰å‡½æ•°æ¥è·å–ã€‚

è¿˜æœ‰ä¸€ä¸ªä¾‹å­ï¼š

```python
>>> from itertools import cycle
>>> def endless():
...     """Yields 9, 8, 7, 6, 9, 8, 7, 6, ... forever"""
...     yield from cycle((9, 8, 7, 6))

>>> e = endless()
>>> total = 0
>>> for i in e:
...     if total < 30:
...         print(i, end=" ")
...         total += i
...     else:
...         print()
...         # Pause execution. We can resume later.
...         break
9 8 7 6 9 8 7 6 9 8 7 6 9 8

>>> # Resume
>>> next(e), next(e), next(e)
(6, 9, 8)
```

ç”Ÿæˆå™¨å¯ä»¥å¿«é€Ÿçš„åœæ­¢å’Œé‡å¯ï¼ˆåœæ­¢å…¶å®æ˜¯æŒ‚èµ·ï¼Œæ‰€æœ‰çš„çŠ¶æ€éƒ½ä¿å­˜äº†ï¼‰ï¼Œåç¨‹å·¥ä½œæ–¹å¼ç±»ä¼¼ï¼Œå¯ä»¥åšåˆ°å¿«é€ŸæŒ‚èµ·ï¼Œç„¶åè®©å‡ºæ§åˆ¶æƒã€‚

ç”Ÿæˆå™¨è¿˜æœ‰ä¸€ä¸ªé²œä¸ºäººçŸ¥çš„ç‰¹ç‚¹ï¼Œåœ¨è°ƒç”¨ç”Ÿæˆå™¨å¯¹è±¡çš„æ—¶å€™å¯ä»¥ä½¿ç”¨sendå‡½æ•°æ¥ä¼ é€’ä¸€äº›ä¿¡æ¯ï¼Œä¾‹å¦‚:

```python
def consumer():
    r = ''
    while True:
        n = yield r
        if not n:
            return
        print('[CONSUMER] Consuming %s...' % n)
        r = '200 OK'
```

å¯ä»¥è¿™ä¹ˆè°ƒç”¨å®ƒ

```python
>>> c = consumer()#äº§ç”Ÿä¸€ä¸ªç”Ÿæˆå™¨
>>> c.send(None)#å¯åŠ¨ç”Ÿæˆå™¨
>>> c.send(12)#è°ƒç”¨ç”Ÿæˆå™¨
[CONSUMER] 12 ...
'200 OK'
```

æ€»ç»“ä¸€ä¸‹ä¸Šé¢æ‰€è¯´çš„ä¸œè¥¿

- åç¨‹å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªç‰¹åˆ«çš„ç”Ÿæˆå™¨
- è€ç‰ˆæœ¬çš„pythonä½¿ç”¨yield formå…³é”®å­—ï¼Œè€Œæ–°ç‰ˆæœ¬çš„ä½¿ç”¨awaitä»£æ›¿ï¼Œè¿™ä¸¤ç§å…³é”®å­—çš„ä½œç”¨æ˜¯ç›¸åŒçš„ï¼Œä½†æ˜¯awaitå¯ä»¥å¸®åŠ©æˆ‘ç›Ÿæ›´å¥½çš„ç†è§£ç¨‹åº
- ç¨‹åºä¼šåœ¨awaitå¤„è®©å‡ºæ§åˆ¶æƒï¼Œç„¶åç»§ç»­æ‰§è¡Œï¼Œç›´åˆ°æ‰§è¡Œçš„ç¨‹åºè¿”å›

## async for ä¸ å¼‚æ­¥ç”Ÿæˆå™¨

ä¸€ä¸ªå¼‚æ­¥ç”Ÿæˆå™¨çš„ä¾‹å­ï¼š

```python
>>> async def mygen(u: int = 10):
...     """Yield powers of 2."""
...     i = 0
...     while i < u:
...         yield 2 ** i
...         i += 1
...         await asyncio.sleep(0.1)
```

å¯ä»¥æŒ‰ç…§å¦‚ä¸‹çš„æ–¹å¼è°ƒç”¨å®ƒ

```python
>>> async def main():
...     # This does *not* introduce concurrent execution
...     # It is meant to show syntax only
...     g = [i async for i in mygen()]
...     f = [j async for j in mygen() if not (j // 3 % 5)]
...     return g, f
...
>>> g, f = asyncio.run(main())
>>> g
[1, 2, 4, 8, 16, 32, 64, 128, 256, 512]
>>> f
[1, 2, 16, 32, 256, 512]
```

å¼‚æ­¥ç”Ÿæˆå™¨ä¸å…¶ä»–å¼‚æ­¥ç¨‹åºçš„åŒºåˆ«æ˜¯ï¼šå¼‚æ­¥ç”Ÿæˆå™¨å¹¶æ²¡æœ‰å°†æ•´ä¸ªå¾ªç¯è¿‡ç¨‹å˜æˆå¹¶å‘çš„è¿‡ç¨‹ï¼Œå³å³ä½¿ä½¿ç”¨äº†å¼‚æ­¥ç”Ÿæˆå™¨ï¼Œå®ƒçš„æ‰§è¡Œé€Ÿåº¦è¿˜æ˜¯å’Œæ™®é€šçš„ç”Ÿæˆå™¨æ²¡æœ‰åŒºåˆ«ã€‚å¼‚æ­¥ç”Ÿæˆå™¨åªæ˜¯è¡¨ç¤ºå¯ä»¥å°†æ§åˆ¶æƒè½¬ç§»ã€‚

## äº‹ä»¶å¾ªç¯ä¸asyncio.run()

å¼‚æ­¥çš„å®ç°æ–¹å¼å¯ä»¥çœ‹ä½œä¸ºä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼Œå³æœ‰ä¸€ä¸ªå¾ªç¯ç¨‹åºåœ¨ä¸åœçš„è¯¢é—®æ¯ä¸€ä¸ªåç¨‹æ˜¯å¦å¯ä»¥å°†æ§åˆ¶æƒè½¬è®©ä»¥åŠæ˜¯å¦å†æ¬¡éœ€è¦æ§åˆ¶æƒï¼Œåœ¨å¾—åˆ°åç¨‹çš„å“åº”ä¹‹åå°†æ§åˆ¶æƒè¿›è¡Œç›¸åº”çš„è½¬ç§»ã€‚

å¯¹äº3.7åŠä»¥ä¸Šç‰ˆæœ¬çš„pythonè€Œè¨€ï¼Œå¯åŠ¨æ—¶é—´å¾ªç¯ï¼Œç„¶åè¿è¡Œåç¨‹å¯ä»¥é€šè¿‡ä¸€å¥å‘½ä»¤å®Œæˆ

```python
asyncio.run(main())
```

å¦‚æœä½ ä¸é™éº»çƒ¦çš„è¯å¯ä»¥è°ƒç”¨å…¶ä»–çš„API

```python
loop = asyncio.get_event_loop()
try:
	loop.run_until_complete(main())
finally:
	loop.close()

# loop.is_running() å¯ä»¥ç”¨æ¥æŸ¥çœ‹æ—¶é—´å¾ªç¯æ˜¯å¦åœ¨è¿è¡Œ
# loop.is_closed()
```

å¦‚æœä½ ä¸éœ€è¦ä¿®æ”¹åç¨‹çš„è¿è¡Œæ–¹å¼ï¼Œç¬¬ä¸€ç§æ–¹å¼ä¼šæ›´åŠ åˆé€‚ä¸€äº›ã€‚

- å•ä¸ªåç¨‹å¹¶ä¸èƒ½èŠ‚çœç¨‹åºçš„è¿è¡Œæ—¶é—´
- æ‰€æœ‰çš„åç¨‹é»˜è®¤éƒ½è¿è¡Œåœ¨å•ä¸ªçº¿ç¨‹å†…ï¼Œè¿™æ„å‘³ç€å¤§é‡çš„åç¨‹ä¼šé€ æˆç¨‹åºè¿è¡Œé€Ÿåº¦çš„æ˜¾è‘—é™ä½ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥åœ¨å¤šä¸ªæ ¸å¿ƒä¸Šé¢è¿è¡Œæ‰€æœ‰åç¨‹ã€‚å‚è€ƒè¿™ä¸ªç½‘å€

[https://youtu.be/0kXaLh8Fz3k?t=10m30s](https://youtu.be/0kXaLh8Fz3k?t=10m30s)

- åç¨‹çš„äº‹ä»¶å¾ªç¯æ˜¯å¯ä»¥è‡ªå®šä¹‰çš„ï¼Œå‚è€ƒè¿™ä¸ªåº“https://github.com/MagicStack/uvloop

# ä¸€ä¸ªå®Œæ•´çš„ä¾‹å­ï¼šå¼‚æ­¥ç½‘ç»œè®¿é—®

åœ¨ä»‹ç»äº†å¼‚æ­¥ioçš„ä½¿ç”¨æ–¹å¼ä¹‹åï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨å¼‚æ­¥ioçš„å®Œæ•´ç¤ºä¾‹

## è¦æ±‚ï¼ˆæµç¨‹ï¼‰

1. è¯»å…¥ä¸€ä¸ªå†…å®¹ä¸ºä¸€ç³»åˆ—urlçš„æ–‡æœ¬æ–‡ä»¶
2. ä½¿ç”¨resuestsæˆ–ç±»ä¼¼çš„åº“è·å–ç½‘é¡µä¿¡æ¯å¹¶è§£æï¼Œå¦‚æœurlæ— æ•ˆåˆ™åœæ­¢å¤„ç†
3. æœç´¢ç½‘é¡µå†…å®¹é‡Œé¢çš„è¶…é“¾æ¥
4. æŠŠæœç´¢åˆ°çš„å†…å®¹å†™å…¥ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶
5. ä½¿ç”¨å¼‚æ­¥æ–¹å¼å®Œæˆä¸Šè¿°æ“ä½œ

## ä½¿ç”¨aiohttpåº“è¿›è¡Œç½‘ç»œè¯·æ±‚ï¼Ÿ

å¼‚æ­¥ç½‘ç»œè®¿é—®éœ€è¦ä½¿ç”¨aiohttpåº“æ¥ä½œä¸ºwebè¯·æ±‚çš„åº“ã€‚è¿™é‡Œä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆä¸ä½¿ç”¨requestsåº“æ¥è¿›è¡Œwebè¯·æ±‚ï¼Ÿrequestsåº“çš„å‡½æ•°è°ƒç”¨éƒ½æ˜¯é˜»å¡çŠ¶æ€çš„ï¼Œå¦‚æœç›´æ¥æ‹¿æ¥åœ¨å¼‚æ­¥ç¨‹åºä¸­ä½¿ç”¨èµ·ä¸åˆ°åç¨‹çš„ä½œç”¨ï¼Œå› ä¸ºé˜»å¡çš„requestså‡½æ•°è°ƒç”¨æ˜¯ä¸å¯ç­‰å¾…çš„ã€‚ä¸€ä¸ªä¾‹å­ï¼š

```python
#!/usr/bin/env python3
# async_call_sync.py

import time
import asyncio

async def request(caller=None):
    for i in range(3):
        time.sleep(1)#è¿™é‡Œä½¿ç”¨ä¸€ä¸ªé˜»å¡çš„sleepæ¥ä»£æ›¿requests.get()
        print(f"{caller}:{i}")

async def test(name):
    await request(name)

async def main():
    await asyncio.gather(*(test(i) for i in range(3)))

if __name__ == "__main__":
    import time
    s = time.perf_counter()
    asyncio.run(main())
    cost = time.perf_counter() - s
    print("%s run cost %0.5f s"%(__file__, cost))
```

è¿è¡Œç¨‹åº

```python
$ python async_call_sync.py
0:0
0:1
0:2
1:0
1:1
1:2
2:0
2:1
2:2
./test.py run cost 9.01359 s
```

å¦‚æœå°†ä¸Šé¢çš„ç¨‹åºä¿®æ”¹ä¸€ä¸‹ï¼š

```python
async def request(caller=None):
    for i in range(3):
        await asyncio.sleep(1)#è¿™é‡Œä½¿ç”¨ä¸€ä¸ªé˜»å¡çš„sleepæ¥ä»£æ›¿requests.get()
        print(f"{caller}:{i}")
```

å†æ¬¡è¿è¡Œ

```python
$ python async_call_sync.py
0:0
1:0
2:0
0:1
1:1
2:1
0:2
1:2
2:2
./test.py run cost 3.00469 s
```

å¦‚æœä½ çœŸçš„å¾ˆæƒ³ä½¿ç”¨requestsåº“ï¼Œé‚£ä¹ˆå¯ä»¥å‚ç…§è¿™ä¸ªæ–‡ç« ä¿®æ”¹:

[https://docs.python.org/3/library/asyncio-eventloop.html#executing-code-in-thread-or-process-pools](https://docs.python.org/3/library/asyncio-eventloop.html#executing-code-in-thread-or-process-pools)

[https://stackoverflow.com/questions/43241221/how-can-i-wrap-a-synchronous-function-in-an-async-coroutine](https://stackoverflow.com/questions/43241221/how-can-i-wrap-a-synchronous-function-in-an-async-coroutine)

[https://zhuanlan.zhihu.com/p/56927974](https://zhuanlan.zhihu.com/p/56927974)

æˆ–è€…ä½¿ç”¨è¿™ä¸ªåº“ [https://github.com/oremanj/greenback](https://github.com/oremanj/greenback)

## ç¤ºä¾‹ä»£ç 

urlæ–‡ä»¶å†…å®¹ï¼Œè¿™äº›urlå¤§éƒ¨åˆ†éƒ½æ˜¯å›½å¤–çš„ç½‘ç«™ï¼Œå¦‚æœæ‰“ä¸å¼€å¯ä»¥ç”¨å›½å†…ç½‘ç«™æ›¿æ¢

```python
$ cat urls.txt
https://regex101.com/
https://docs.python.org/3/this-url-will-404.html
https://www.nytimes.com/guides/
https://www.mediamatters.org/
https://1.1.1.1/
https://www.politico.com/tipsheets/morning-money
https://www.bloomberg.com/markets/economics
https://www.ietf.org/rfc/rfc2616.txt

$ cat urls_cn.txt
https://regex101.com/
https://1.1.1.1/
https://www.163.com
https://www.qq.com
https://www.baidu.com
https://www.sina.com
```

```python
#!/usr/bin/env python3
#areq.py

import asyncio
import logging
import re
import sys

from typing import IO
import urllib.error
import urllib.parse

import aiofiles
import aiohttp
from aiohttp import ClientSession

logging.basicConfig(
    format="%(asctime)s %(levelname)s: %(name)s:%(message)s",
    level=logging.DEBUG,
    datefmt="%H-%M-%S",
    stream=sys.stderr,
)

logger = logging.getLogger("areq")
logging.getLogger("charder.charsetprober").disabled = True

HREF_RE = re.compile(r'href="(.*?)"')

async def fetch_html(url:str, session:ClientSession, **kwargs)->str:

    resp = await session.request(method="GET", url=url, **kwargs)
    resp.raise_for_status()
    logger.info("Got response [%s] for URL:%s", resp.status, url)
    html = await resp.text()
    return html

async def parse(url:str, session:ClientSession, **kwargs)->set:

    found = set()
    try:
        html = await fetch_html(url=url,session=session, **kwargs)
    except (
        aiohttp.ClientError,
        aiohttp.http_exceptions.HttpProcessingError,
    ) as e:
        logger.error(
            "aiohttp exception for %s [%s]: %s",
            url,
            getattr(e, "status", None),
            getattr(e, "message", None)
        )
        return found

    except Exception as e:
        logger.exception(
            "Non-aiohttp exception occured:  %s", getattr(e, "__dict__", {})
        )
        return found

    else:

        for link in HREF_RE.findall(html):
            try:
                abslink=urllib.parse.urljoin(url, link)
            except (urllib.error.URLError, ValueError):
                logger.exception("Error parseing URL: %s", link)
                pass
            else:
                found.add(abslink)

        logger.info("Fond %d links for %s", len(found), url)
        return found

async def write_one(file:IO, url:str, **kwargs)->None:
    res = await parse(url=url, **kwargs)
    if not res:
        return None
    async with aiofiles.open(file, "a") as f:
        for p in res:
            await f.write(f"{url}\t{p}\n")
        logger.info("Wrote res for source Url: %s", url)

async def bulk_crawl_and_write(file:IO, urls:set, **kwargs)->None:

    async with ClientSession() as session:
        tasks = []
        for url in urls:
            tasks.append(
                write_one(file=file, url=url, session=session, **kwargs)
            )

        await asyncio.gather(*tasks)

if __name__ == "__main__":
    import pathlib
    import sys

    header = {"User-Agent":"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.20 Safari/537.36 Edg/97.0.1072.21"}
    assert sys.version_info >= (3,7)
    here = pathlib.Path(__file__).parent

    with open(here.joinpath("urls.txt")) as infile:
        urls = set(map(str.strip, infile))

    outpath = here.joinpath("foundurls.txt")
    with open(outpath, "w") as outfile:
        outfile.write("source_uirl\tparsed_url\n")

    asyncio.run(bulk_crawl_and_write(file=outpath, urls=urls, headers=header))
```

è¿è¡Œç¨‹åºæŸ¥çœ‹ç»“æœï¼š

```python
$ python areq.py
14-01-24 DEBUG: asyncio:Using selector: EpollSelector
14-01-24 ERROR: areq:aiohttp exception for https://1.1.1.1/ [None]: None
14-01-24 INFO: areq:Got response [200] for URL:https://www.baidu.com
14-01-24 INFO: areq:Got response [200] for URL:https://www.sina.com
14-01-24 DEBUG: chardet.charsetprober:utf-8  confidence = 0.99
14-01-24 DEBUG: chardet.charsetprober:SHIFT_JIS Japanese confidence = 0.01
14-01-24 DEBUG: chardet.charsetprober:EUC-JP Japanese confidence = 0.01
14-01-24 DEBUG: chardet.charsetprober:GB2312 Chinese confidence = 0.01
14-01-24 DEBUG: chardet.charsetprober:EUC-KR Korean confidence = 0.01
14-01-24 DEBUG: chardet.charsetprober:CP949 Korean confidence = 0.01
14-01-24 DEBUG: chardet.charsetprober:Big5 Chinese confidence = 0.01
14-01-24 DEBUG: chardet.charsetprober:EUC-TW Taiwan confidence = 0.01
14-01-24 DEBUG: chardet.charsetprober:windows-1251 Russian confidence = 0.01
14-01-24 DEBUG: chardet.charsetprober:KOI8-R Russian confidence = 0.01
14-01-24 DEBUG: chardet.charsetprober:ISO-8859-5 Russian confidence = 0.0
14-01-24 DEBUG: chardet.charsetprober:MacCyrillic Russian confidence = 0.010057786647123132
14-01-24 DEBUG: chardet.charsetprober:IBM866 Russian confidence = 0.07572707827332002
14-01-24 DEBUG: chardet.charsetprober:IBM855 Russian confidence = 0.038816770341240835
14-01-24 DEBUG: chardet.charsetprober:ISO-8859-7 Greek confidence = 0.0
14-01-24 DEBUG: chardet.charsetprober:windows-1253 Greek confidence = 0.0
14-01-24 DEBUG: chardet.charsetprober:ISO-8859-5 Bulgairan confidence = 0.0
14-01-24 DEBUG: chardet.charsetprober:windows-1251 Bulgarian confidence = 0.0
14-01-24 DEBUG: chardet.charsetprober:TIS-620 Thai confidence = 0.041924869728195514
14-01-24 DEBUG: chardet.charsetprober:ISO-8859-9 Turkish confidence = 0.5002036123642747
14-01-24 DEBUG: chardet.charsetprober:windows-1255 Hebrew confidence = 0.0
14-01-24 DEBUG: chardet.charsetprober:windows-1255 Hebrew confidence = 0.0
14-01-24 DEBUG: chardet.charsetprober:windows-1255 Hebrew confidence = 0.0
14-01-24 DEBUG: chardet.charsetprober:utf-8  confidence = 0.99
14-01-24 DEBUG: chardet.charsetprober:SHIFT_JIS Japanese confidence = 0.01
14-01-24 DEBUG: chardet.charsetprober:EUC-JP Japanese confidence = 0.01
14-01-24 DEBUG: chardet.charsetprober:GB2312 Chinese confidence = 0.01
14-01-24 DEBUG: chardet.charsetprober:EUC-KR Korean confidence = 0.01
14-01-24 DEBUG: chardet.charsetprober:CP949 Korean confidence = 0.01
14-01-24 DEBUG: chardet.charsetprober:Big5 Chinese confidence = 0.01
14-01-24 DEBUG: chardet.charsetprober:EUC-TW Taiwan confidence = 0.01
14-01-24 INFO: areq:Fond 6 links for https://www.sina.com
14-01-24 INFO: areq:Got response [200] for URL:https://www.163.com
14-01-24 INFO: areq:Wrote res for source Url: https://www.sina.com
14-01-25 INFO: areq:Fond 45 links for https://www.baidu.com
14-01-25 INFO: areq:Wrote res for source Url: https://www.baidu.com
14-01-25 INFO: areq:Fond 1179 links for https://www.163.com
14-01-25 INFO: areq:Wrote res for source Url: https://www.163.com
14-01-25 INFO: areq:Got response [200] for URL:https://regex101.com/
14-01-25 INFO: areq:Fond 40 links for https://regex101.com/
14-01-25 INFO: areq:Wrote res for source Url: https://regex101.com/

# æŸ¥çœ‹è¾“å‡ºæ–‡ä»¶
$ head foundurls.txt -n3
source_uirl	parsed_url
https://www.sina.com	http://www.sina.com.cn/intro/copyright.shtml
https://www.sina.com	https://weibo.com/sinaus?ssl_rnd=1609344845.1816&is_all=1

$ wc -l foundurls.txt
1271 foundurls.txt

```

<aside>
ğŸ’¡ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨ç½‘ç»œè®¿é—®ç¨‹åºçš„æ—¶å€™ï¼Œä¸è¦å¯¹åŒä¸€ä¸ªç½‘ç«™å‘èµ·è¿‡å¤šä¸è¿‡äºé¢‘ç¹çš„è¯·æ±‚ã€‚è¿™æ ·ä¸ä»…ä¼šå¢åŠ ç½‘ç«™çš„è´Ÿæ‹…ï¼Œç¨‹åºä¹Ÿä¼šå› ä¸ºtimeouté”™è¯¯å¾—ä¸åˆ°æ•°æ®ã€‚å¦‚æœæœ‰ä¸€äº›ç½‘ç«™ä¸€ç›´å¾—ä¸åˆ°è¿”å›æ•°æ®ï¼Œå¯ä»¥å°è¯•åœ¨è¯·æ±‚çš„æ—¶å€™æ·»åŠ headerså‚æ•°ã€‚

</aside>

# ä»€ä¹ˆåœºæ™¯æ›´åŠ é€‚åˆå¼‚æ­¥IO

åœ¨ä»¥ä¸Šçš„å†…å®¹å¯¹å¼‚æ­¥IOä»‹ç»äº†é‚£ä¹ˆå¤šåï¼Œç›¸ä¿¡ä½ ä¸€å®šå¯¹å¼‚æ­¥IOçš„ä½¿ç”¨åœºæ™¯æœ‰ä¸€å®šçš„äº†è§£ã€‚ä¸€èˆ¬æ¥è¯´IOå¯†é›†çš„ä»»åŠ¡éƒ½å¯ä»¥ä½¿ç”¨å¼‚æ­¥IOï¼Œå› ä¸ºæ­¤æ—¶CPUå¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨ç­‰å¾…IOçš„è¿”å›ç»“æœï¼š

- ç½‘ç»œIOï¼ŒæœåŠ¡ç«¯æˆ–è€…å®¢æˆ·ç«¯
- æ— æœåŠ¡æƒ…å†µï¼ŒP2Pæˆ–è€…å¤šäººç½‘ç»œèŠå¤©å®¤
- ä¸æƒ³åœ¨ä½¿ç”¨å¤šçº¿ç¨‹åŠ é”ä¿æŠ¤æ•°æ®è¿›è¡Œæ•°æ®è¯»å†™çš„æƒ…å†µ

# é›¶ç¢çš„çŸ¥è¯†ç‚¹

## asyncio.create_task

ä¸ä»…asyncio.gatherå¯ä»¥åˆ›å»ºåç¨‹ï¼Œcreate_taskä¹Ÿå¯ä»¥ï¼Œä¾‹å­ï¼š

```python
>>> import asyncio

>>> async def coro(seq) -> list:
...     """'IO' wait time is proportional to the max element."""
...     await asyncio.sleep(max(seq))
...     return list(reversed(seq))
...
>>> async def main():
...     # This is a bit redundant in the case of one task
...     # We could use `await coro([3, 2, 1])` on its own
...     t = asyncio.create_task(coro([3, 2, 1]))  # Python 3.7+
...     await t # å¦‚æœè¦è·å–åç¨‹çš„è¿”å›å€¼ï¼Œå¯ä»¥ä½¿ç”¨ ret = await t
...     print(f't: type {type(t)}')
...     print(f't done: {t.done()}')
...
>>> t = asyncio.run(main())
t: type <class '_asyncio.Task'>
t done: True
```

åœ¨mainå‡½æ•°ä¸­å¿…é¡»ä½¿ç”¨awaitæ¥ç­‰å¾…tçš„å®Œæˆï¼Œå› ä¸ºåœ¨ä½¿ç”¨asyncio.runçš„æ—¶å€™ä¼šè°ƒç”¨å‡½æ•°`[loop.run_until_complete(main())](https://github.com/python/cpython/blob/7e18deef652a9d413d5dbd19d61073ba7eb5460e/Lib/asyncio/runners.py#L43)` æ‰€æœ‰æ•´ä¸ªæ—¶é—´å¾ªç¯åªä¼šå…³å¿ƒmainè¿™ä¸ªåç¨‹æ˜¯å¦å·²ç»å®Œæˆï¼Œå…¶ä»–çš„åç¨‹åœ¨å®Œæˆä¹‹å‰å°±ä¼šè¢«å–æ¶ˆ ï¼Œå¦‚æœä½ æƒ³å¾—åˆ°ç›®å‰æ‰€æœ‰åœ¨ç­‰å¾…çš„åç¨‹å¯ä»¥ä½¿ç”¨ asyncio.Task.all_tasks()è¿™ä¸ªå‡½æ•°æŸ¥çœ‹ã€‚

å¯¹äºgather()å‡½æ•°ï¼Œå®ƒçš„ä½œç”¨åªæ˜¯å°†æ‰€æœ‰çš„åç¨‹ï¼ˆfuturesï¼‰æ”¾å…¥åˆ°ä¸€ä¸ªåç¨‹ï¼ˆfuturesï¼‰ä¸­ï¼Œå¦‚æœä½¿ç”¨awaitå¼€ç­‰å¾…gather()å‡½æ•°çš„åç¨‹ï¼Œå°±æ˜¯åœ¨ç­‰å¾…æ‰€æœ‰æ”¾å…¥gatherçš„åç¨‹ã€‚å¹¶ä¸”gather()å‡½æ•°è¿˜å¯ä»¥è·å¾—åç¨‹çš„è¿”å›ç»“æœã€‚

```python
>>> import time
>>> async def main():
...     t = asyncio.create_task(coro([3, 2, 1]))
...     t2 = asyncio.create_task(coro([10, 5, 0]))  # Python 3.7+
...     print('Start:', time.strftime('%X'))
...     a = await asyncio.gather(t, t2)
...     print('End:', time.strftime('%X'))  # Should be 10 seconds
...     print(f'Both tasks done: {all((t.done(), t2.done()))}')
...     return a
...
>>> a = asyncio.run(main())
Start: 16:20:11
End: 16:20:21
Both tasks done: True
>>> a
[[1, 2, 3], [0, 5, 10]]
```

gather()å‡½æ•°åªæœ‰å½“æ‰€æœ‰æ”¾å…¥çš„åç¨‹éƒ½å®Œæˆä¹‹åæ‰ä¼šè¿”å›ï¼Œå¦‚æœæƒ³å•ç‹¬è¿”å›å·²ç»å®Œæˆçš„åç¨‹å€¼ï¼Œå¯ä»¥è¿™æ ·

```python
>>> async def main():
...     t = asyncio.create_task(coro([3, 2, 1]))
...     t2 = asyncio.create_task(coro([10, 5, 0]))
...     print('Start:', time.strftime('%X'))
...     for res in asyncio.as_completed((t, t2)):
...         compl = await res
...         print(f'res: {compl} completed at {time.strftime("%X")}')
...     print('End:', time.strftime('%X'))
...     print(f'Both tasks done: {all((t.done(), t2.done()))}')
...
>>> a = asyncio.run(main())
Start: 09:49:07
res: [1, 2, 3] completed at 09:49:10
res: [0, 5, 10] completed at 09:49:17
End: 09:49:17
Both tasks done: True
```

## è¯­æ³•é—®é¢˜

æ›´å¤šawaitçš„ä½¿ç”¨æ–¹æ³•å¯ä»¥å‚è€ƒè¿™ä¸ªï¼š[examples ofÂ `await`Â expressions](https://www.python.org/dev/peps/pep-0492/#examples-of-await-expressions)Â from PEP 492.

# å‚è€ƒæ–‡çŒ®

[asyncio - Asynchronous I/O - Python 3.10.1 documentation](https://docs.python.org/3/library/asyncio.html)

[Async IO in Python: A Complete Walkthrough - Real Python](https://realpython.com/async-io-python/)

[åç¨‹](https://www.liaoxuefeng.com/wiki/1016959663602400/1017968846697824#0)
